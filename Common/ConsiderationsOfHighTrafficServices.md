# 대규모서비스
---

## 대규모서비스가 가져야할 특성

- Elastic
    - 확장성
    - 서비스의 확장과 축소가 자유롭고 쉬워야 함
- Resiliency
    - 장애회복성
    - 서비스 장애시 가능한 매뉴얼 처리가 없이 자동 회복되어야 함
- Automation
    - 자동화
    - 배포부터 장애처리 등 대부분이 자동화 되어 있어, 버튼 클릭만으로 진행되어야 함
- Monitoring
    - 모니터링
    - 서비스 상태는 항상 모니터링 되어야함.

## SPOF(Single Point of Failure)

- 어떤 지점에 장애가 발생하면 전체 서비스에 장애를 낼 수 있는 부분
    - ex. 
    - 단일 서버 운영시 
    - Switch, Route 등 서버 외의 하드웨어 부분
    - Network Bandwidth 한계
        - 10Gbps 스위치에 3개의 서버가 붙어있고 각각이 8G/2G/2G를 사용하여 10Gbps 이상의 데이터 전달이 발생 -> Capacity를 넘어가는 순간부터 Packet Drop이 발생
    - Switch의 장애

## 서비스가 잘 동작하는지 모니터링 하기 위한 지표
- 서비스에서의 지표
    - API 요청 수
        - 현재 요청 중인 초당 요청 수
        - 실패한 초당 요청 수
    - API Latency
        - APIs의 Median, 99 percentile, max, 등
        - 단순 평균보다는 Median 값이 좀 더 의미를 가질 수 있음.
            - 속도들의 분포 파악
    - 서버의 상태
        - CPU(DB 및 API 서버, Cache 서버 등), 메모리, 디스크, 네트워크, 정상적인 서버 수
    - 에러 로그 수집
        - Sentry의 사용
    - 외부 모니터링 서비스
        - AWS cloudwatch, Datadog, New Relic, Watap, Grafana, ELK 등
        - 비용이 들지만, 훨씬 편리
    - Alarm
        - 모니터링 지표 이상 발생시 알람
        - 알람에 등급을 나눠서 미리 전송
            - 장애의 정도
                - 서비스의 영향도는?
            - 행동의 여부
                - 즉각 조치 필요한가?

## 서비스 출시 전 성능/부하/스트레스 테스트
- 서비스 출시전 해당 서비스가 어느 정도의 안정성을 가질 수 있는지를 위한 테스트
    - 성능/부하/스트레스 테스트로 나눌 수 있음
    - 성능테스트
        - 해당 서비스가 어느정도의 성능을 내는지? ex. 1000TPS의 성능
    - 부하테스트
        - 해당 서비스의 어느 부분에서 어느 정도 부하가 걸리는지 알아보는 테스트
    - 스트레스 테스트
        - 성능/부하 테스트가 특정 시간 이상 지속적으로 안정적으로 되는지 확인하는 테스트
- 성능 테스트 시에 주의할 점
    - 주요 시나리오를 테스트 하는지?
        - 실제 서비스에서 사용되는 패턴(여러 API의 조합)으로 테스트 필요
    - 클라이언트의 성능 한계 확인
        - 부하를 주는 클라이언트의 한계로 성능 측정이 어려울 수 있으므로, 클라이언트를 점점 늘리면서 테스트 해야함.
    - 성능 테스트 시에 확인해야할 부분
        - OS에서 설정하는 값들에 대한 확인 필요
            - ulimit -a
                - Open Files: OS에서 열 수 있는 파일의 개수
                    - 네트워크로 접속되는 대부분이 소켓인데, 이 소캣도 대부분 파일임! 그러므로 이 개수가 작으면 그 만큼 소켓을 열수 없음
                - Max User Processes라는 값의 튜닝 필요
            - /etc/limits.conf를 수정
            - 수정 후에 기본적으로 재시작이 필요
        - AWS ec2는 재시작 하는 것보다는 사용하는 AMI에 기본적인 설정을 해두고 이를 이용하는 것이 좋음.
- 성능 테스트 Tools
    - Ngrinder
        - 평균/최대 TPS, 성공 수, 실패 수 등을 알 수 있음.
        - 단, Ngrinder는 단점이 실패 수가 전체의 30%를 넘어가면 테스트가 끝까지 않고 끝나버림.
        - 대신 쉽게 사용 가능한 장점
    - Locust
    - JMeter
    - Gatling
    - ab

## 로드밸런싱
- 서버 사이드 로드 밸런싱
    - 클라이언트의 리퀘스트를 분산
    - 클라이언트는 서버의 개별 주소를 알 필요 없음. 로드밸런서의 주소만 알면됨.
    - 실제적으로 한 단계를 더 거치는 것이므로 Latency가 늘어날 수 있음. 이를 Hop(홉)이라고 부름
    - 로드밸런서에 장애가 발생하면 서비스 불가
- 클라이언트 사이드 로드 밸런싱
    - 클라이언트 서버의 대수 및 주소를 모두 알아야하는 큰 단점
    - Hop이 존재하지 않으므로 좀 더 빠른 Latency
    - 로드밸런서가 없기 때문에 장애포인트가 줄어듬
    - 클라이언트에서 서버의 목록과 주소를 관리해야하는 단점
